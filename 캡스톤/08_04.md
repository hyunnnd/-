## ✅ SBP 이상치 판단 로직 정리

### 📌 목적

10초 단위로 분할한 SBP 시계열에서 **비정상적인 혈압 구간(이상치)** 을 탐지하기 위한 기준을 설정하고, 해당 구간을 식별함.

### 🧩 분석 개요

- 입력: SBP 시계열 데이터 (`sbp_dict[record_id]`)
- 단위: 10초(=100샘플 기준)로 구간 분할
- 방식: 구간별로 변화량, 추세선 기울기, 분산 등을 활용하여 이상 여부 판단

### 📊 이상치 판단 기준

|구분|조건|설명|
|---|---|---|
|**1. 절대값 기반**|`SBP > 250` 또는 `SBP < 50`|생리적으로 불가능한 값|
|**2. 변화량 기반**|`diff > 40` 또는 `< -40`|순간적인 급격한 상승·하강|
|**3. 추세선 기울기**|`abs(slope) > 5.0`|추세선의 기울기가 급격한 경우|
|**4. 변동폭 기준**|`IQR > 30`|구간 내 SBP 값 분산이 큰 경우|

## 📝 요약 표

| 논문/출처                           | 이상치 기준                                      | 설명 & 위치                                                                                                                                                                                                                                        |
| ------------------------------- | ------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Finnegan et al. (2021)          | ∣zk−median(Z)∣>5×MAD                        | beat-by-beat amplitude outlier 및 SQI 계산 기준 [Nature+9Nature+9ResearchGate+9](https://www.nature.com/articles/s41598-021-01358-4?utm_source=chatgpt.com)                                                                                         |
| ICU PPG Spike 연구 (2024)         | SBP > 30 mmHg, DBP > 15 mmHg, MBP > 20 mmHg | PPG 기반 “Spike/Dip/Stable” 분류 기준 [arXiv](https://arxiv.org/abs/2407.03274?utm_source=chatgpt.com)                                                                                                                                               |
| Emory Healthcare 대규모 데이터 (2024) | SBP: 20–200 mmHg, DBP: 30–300 mmHg          | 임상값 범위 벗어난 측정은 이상치로 제외 [arXiv](https://arxiv.org/html/2402.01598v3?utm_source=chatgpt.com)                                                                                                                                                     |
| Mahalanobis 거리 기반 (2021)        | p < 0.001 임계값 기반 다변량 이상치 제거                 | KNHANES에서 feature multivariate filtering [ResearchGate](https://www.researchgate.net/publication/355869942_Mahalanobis_Distance_Based_Multivariate_Outlier_Detection_to_Improve_Performance_of_Hypertension_Prediction?utm_source=chatgpt.com) |


- **레코드 로드**
    
    - `wfdb.rdrecord()`로 MIMIC III 원시 파일을 읽어 **ABP(동맥혈압)**·**PLETH(PPG)** 두 채널이 모두 존재하는 경우에만 보관합니다.
    - 로드된 `DataFrame`을 피클(`.pkl`)로 캐싱하여 재실행 시간을 단축합니다.

- **10 초 세그먼트 분할**
    
    - 표본화 주파수 `fs = 125 Hz`이므로 세그먼트 길이는 `fs × seg_sec = 1250` 샘플입니다.
    - 남는 구간(10 초 미만)은 버립니다.

- **SBP·DBP 계산**
    
    - 세그먼트마다 `find_peaks`로 **상방 피크(SBP)**, `find_peaks(-seg…)`로 **하방 피크(DBP)**를 검출합니다.
    - 검출된 피크들의 **중앙값**을 해당 세그먼트의 SBP·DBP 대표값으로 사용합니다.

- **이상치 탐지**
    
    1. **중앙값–MAD(Median Absolute Deviation) 규칙**
        ![[Pasted image 20250805122320.png]]
        - 여기서 xi​는 세그먼트별 SBP(또는 DBP), x~는 전체 세그먼트의 **중앙값**, 
		 MAD=median⁡ ⁣(∣xi−x~∣)
        - SBP는 k=4.0, DBP는 k=5.0을 사용합니다.

    2. **생리학적 절대 범위**
        - SBP 60 – 200 mmHg, DBP 40 – 120 mmHg를 벗어나면 이상치로 간주합니다.

    3. **결측값 처리**
        
        - 피크를 하나도 찾지 못해 `NaN`인 세그먼트는 무조건 이상치로 표시합니다.

    세 가지 조건 중 하나라도 참이면 `outlier_idx[rid]`가 `True`가 됩니다.

- **시각화**

    - 레코드별 SBP(검은색), DBP(파란색)를 선으로 그린 뒤, 이상치 구간(DBP 기준)을 빨간 점으로 표시합니다.